{"version":3,"sources":["client.js"],"names":[],"mappings":"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","file":"client.js","sourcesContent":["/**\n * client.js\n *\n * @author  Denis Luchkin-Zhou <denis@ricepo.com>\n * @license MIT\n */\n\nimport _           from 'lodash';\nimport OS          from 'os';\nimport URL         from 'url';\nimport Chalk       from 'chalk';\nimport Debug       from 'debug';\nimport Twilio      from 'twilio/lib/Client';\nimport Bluebird    from 'bluebird';\nimport Monologue   from 'monologue.js';\n\nconst debug = Debug('ignis:twilio:client');\n\n\n/*!\n * Fake call object template.\n */\nconst fakeCall = {\n  sid: 'fake_call',\n  update: (i, f) => f()\n};\n\n/*!\n * Extended Twilio client with support for dry run.\n */\nexport default class Client extends Twilio {\n\n  constructor(cfg) {\n    super(cfg.sid, cfg.token, cfg.apiHost, cfg.version, cfg.timeout);\n\n    /* Hostname for URL resolution */\n    this.host = process.env.HOSTNAME || cfg.hostname || 'http://' + OS.hostname();\n\n    /* Setup host URL */\n    const parsed = URL.parse(this.host);\n    if (cfg.auth) {\n      parsed.auth = `${cfg.auth.username}:${cfg.auth.password}`;\n    }\n    this.host = URL.format(parsed);\n\n    /* Dry run, which either omits or redirects calls/messages */\n    this.config = cfg;\n    this.dry = cfg.dry || false;\n  }\n\n\n  /*!\n   * Makes a call, respecting the dry run\n   */\n  call(number, params) {\n\n    /* Substitute with dry-run numbers if specified */\n    if (this.dry) {\n      params.to = this.dry;\n    } else {\n      params.to = number;\n    }\n\n    /* Initialize default values */\n    _.defaults(params, this.config.call);\n\n    /* Resolve relative URIs */\n    params.statusCallback = params.statusCallback ?\n      URL.resolve(this.host, params.statusCallback) : '';\n    params.url = URL.resolve(this.host, params.url);\n\n    /* Make the call if we actually have destination numbers */\n    if (_.isArray(params.to)) { params.to = params.to[0]; }\n    if (params.to && typeof params.to === 'string') {\n      return Bluebird.fromNode(done => this.makeCall(params, done));\n    }\n\n    debug(`${Chalk.bold.yellow('[dry-run]')} Skipping the call.`);\n    return Bluebird.resolve(fakeCall);\n  }\n\n\n  /*!\n   * Sends a test message, respecting the dry run\n   */\n  text(number, params) {\n\n    /* Substitute with dry-run numbers if specified */\n    if (this.dry) { number = this.dry; }\n\n    /* Set up the message template */\n    const template = _.defaults({ body: params.message }, this.config.text);\n\n    /* Send out messages */\n    const promises = _\n      .chain([number])\n      .flatten()\n      .compact()\n      .map(phone => _.assign({ to: phone }, template))\n      .map(data => Bluebird.fromNode(done => this.sendSms(data, done)))\n      .value();\n\n    return Bluebird.all(promises);\n  }\n\n\n  /*!\n   * Gets a call's data.\n   */\n  async find(sid) {\n    const call = await this.calls(sid).get();\n    return call;\n  }\n\n\n  /*!\n   * Updates a call.\n   */\n  async update(call, changes) {\n    return Bluebird.fromNode(done => call.update(changes, done));\n  }\n\n\n}\n\n\n/*!\n * Let Client instances emit events.\n */\nMonologue.mixInto(Client);\n"],"sourceRoot":"/source/"}